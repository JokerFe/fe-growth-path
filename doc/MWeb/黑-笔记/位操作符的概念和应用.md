# 位操作符的概念和应用

## 位操作符的概念

位操作符用于在最基本的层次上，即按内存中表示数值的位来操作数值。ECMAScript中的所有数值都以IEEE-754 64位格式存储，但位操作符并不直接操作64位的值。而是先将64位的值转换成32位的整数，然后执行操作，最后再将结果转换回64位。对于开发人员来说，由于64位存储格式是透明的，表面上看起来就好像是在操作32位数值，就跟在其他语言中以类似方式执行二进制操作一样。但这个转换过程也导致了一个严重的副效应，即在对特殊的NaN和Infinity值应用位操作时，这两个值都会被当成0来处理。如果对非数值应用位操作符，会先使用Number()函数将该值转换为一个数值（自动完成），然后在应用位操作，得到的结果将是一个数值。对于有符号的整数，32位中的前31位（从右向前数）用于表示整数的值。第32位用于表示数值的符号：0表示正数，1表示负数。这个标识符号的位叫做符号位，符号位的值决定了其他位数值的格式。位操作符的运算优先级比较低，因为尽量使用括号来确保运算顺序，否则很可能会得到莫明其妙的结果。

## 正数的存储格式

正数以纯二进制格式存储，31位中的每一位都代表2的幂，第一位（叫做位0）表示2^0，第二位表示21，以此类推，没有用到的位以0填充，即忽略不计。例如数值18的二进制表示的是00000000000000000000000000010010,或者更简洁的10010，这是5个有效位，决定了实际的值

demo：

	> 二进制：10010
	>
	> 计算规则：（2<sup>^</sup>4x1）+（2<sup>^</sup>3x0）+（2<sup>^</sup>2x0）+（2<sup>^</sup>1x1）+（2<sup>^</sup>0x0）
	>
	> 计算结果：18

## 负数的存储格式

负数同样以二进制码存储，但使用的格式是二进制补码，计算一个数值的二进制补码，需要经过下列三个步骤：

1.  求这个数值绝对值的二进制码(例如，要求-18的二进制补码，先求18的二进制码)。
2. 求二进制反码，即将0替换为1，将1替换为0。
3. 得到的二进制反码加1。

demo:

> 原数字：18
>
> 二进制原码：00000000000000000000000000010010
>
> 二进制反码：11111111111111111111111111101101
>
> 二进制补码：11111111111111111111111111101110

CMAScript会尽力向我们隐藏所有这些信息，在以二进制字符串形式输出一个负数时，我们只看到这个负数绝对值的二进制前面加个负号

`var num = -18; console.log(num.toString(2));` //"-10010"

## 按位非

按位非操作符由一个(~)表示，执行按位非的结果就是返回数值的反码，按位非操作的本质就是：操作数的负值减1，由于按位非是在数值表示的最底层执行操作，因此速度更快。

```js
var num1 = 25;//二进制00000000000000000000000000011001
var num2 = ~num1;//二进制11111111111111111111111111100110
console.log(num2);//-26
//上面的代码和下面的代码效果相同，但上面的执行速度更快
var num1 = 25;
var num2 = -num-1;
console.log(num2);//-26
```

## 按位与

按位与操作符由一个和号字符(&)表示，它有两个操作符数，按位与操作就是将两个数值的每一位对齐，然后根据全一为一，否则为零的规则进行AND操作。

```js
var result = 25 & 3;
console.log(result);//1
//底层操作如下：
25 = 00000000000000000000000000011001
3  = 00000000000000000000000000000011
&  = 00000000000000000000000000000001
```

## 按位或

按位或操作符由一个竖线符号(|)表示，同样也有两个操作数，按照有1就返回1，全0返回0的规则

```js
var result = 25 | 3
console.log(result);//27
//底层操作如下：
25 = 00000000000000000000000000011001
3  = 00000000000000000000000000000011
|  = 00000000000000000000000000011011
```

## 按位亦或

按位异或操作符由一个插入符号（^）表示，也有两个操作数,按照相同为0，不同为1的规则

```js
var result = 25^3
console.log(result);//26
//底层操作如下
25 = 00000000000000000000000000011001
3  = 00000000000000000000000000000011
^  = 00000000000000000000000000011010
```

## 左移

左移操作符由两个小于号(<<)表示，这两个操作符会将数值的所有位向左移动指定的位数，左移操作后会以0来填充空位,以便得到的结果是一个完整的32位二进制数，例如，如果将数值2(二进制码为10)向左移动5位，结果就是64(二进制码为1000000)。左移不会影响操作数的符号位，如果将-2左移5位，结果将是-64而不是64

```js
var oldValue = 2;
var newValue = oldValue<<5;
console.log(newValue);//64
```

## 有符号右移

有符号的右移操作由两个大于号(>>)表示，这个操作符会将数值向右移动，但保留符号位，在移位过程中，原数值出现的空位用符号位的值来填充，以便得到一个完整的值。

```js
var oldValue = 64;
var newValue = oldValue>>5;
console.log(newValue);//2
```

## 无符号右移

无符号右移操作由3个大于号(>>>)表示,这个操作符会将数值的所有32位都向右移动，对正数来说，无符号的右移结果与有符号右移相同。但对负数来说，无符号右移是以0来填充空位，而不是像有符号右移那样以符号位的值来填充空位，其次，无符号右移操作符会把负数的二进制码当成正数的二进制码，由于负数以其绝对值的二进制补码形式表示，因此会导致无符号右移后的结果非常之大。

```js
var oldValue = -64;
var newValue = oldValue >>>5;
console.log(newValue);//134217726
```

## 位操作符的应用

1. 用位操作符快速取整

```js
var num = 102.34;
console.log(0|num); //102
console.log(~~num); //102
console.log(num>>>0);//102
console.log(num>>0);//102
console.log(num<<0);//102
// 注意：~~(-2.999); // -2; Math.floor(-2.999);//-3
```

2. 将十进制转化为二进制

```js
(-5>>>0).toString(2);//"11111111111111111111111111111011" 真实二进制
(-5).toString(2);//"-101" 有效位+符号
```

3. 判断奇偶数

```js
console.log(n&1===0) //偶数，！==0就是奇数
```

4. RGB2HEX

```js
function RGB2HEX(a,b,c){return"#"+((256+a<<8|b)<<8|c).toString(16).slice(1)}
//或者
function toHexString(r,g,b) {
    return ("00000" + (r << 16 | g << 8 | b).toString(16)).slice(-6);
}
var hex = toHexString(red, green, blue);
```

5. 检测相等关系

```js
a!=b <=> a^b  返回0就是相等，返回1就是不相等
```

6. 默认值

```js
if(!n) n = defaultValue <=> n || (n = defaultValue);
```

7. indexOf和～

```js
// 在代码中常使用String.indexOf，例如：

'abc'.indexOf('d')===-1;
if('abc'.indexOf(str)!==-1){
//在字符串中
}
// 我们可以这样来写

~'abc'.indexOf('d')===0;
if(~'abc'.indexOf('d')){
//在字符串中
}
if(!~'abc'.indexOf('d')){
//不在字符串中
}
```

8. 交换两个数字

```js
function Swap(a,b)  
{  
    if (a != b)  
    {  
        a ^= b;  
        b ^= a;  
        a ^= b;  
    }  
}  
```

9. 变换符号

```js
b = ~a+1; // b =-a;
```

10. 求绝对值

```js
var i = a>>31; //要注意如果a为正数，i等于0，为负数，i等于-1
// return i == 0?a:(~a+1);
    // 优化
    // 对于任何数，与0异或都会保持不变，与-1即0xFFFFFFFF异或就相当于取反。
    // 因此，a与i异或后再减i（因为i为0或-1，所以减i即是要么加0要么加1）也可以得到绝对值
    return ((a^i)-i);
```



